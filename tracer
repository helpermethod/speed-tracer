#!/usr/bin/env bash

tracer() {
  { PS4='\033[0D ${BASH_SOURCE}:${FUNCNAME}:${LINENO}: '; set -x; "$@"; } 2>&1 >/dev/null | {
    # skip the first line
    IFS= read -r

    local start=${EPOCHREALTIME/,/}
    local last=$start

    IFS= read -r

    local last_line=$REPLY
    local elapsed_line
    local padding

    while IFS= read -r; do
      elapsed_line=$((${EPOCHREALTIME/,/} - last))
      last=${EPOCHREALTIME/,/}
      elapsed_line_micro_secs=$((elapsed_line % 1000000))
      padding=$((6 - ${#elapsed_line_micro_secs}))

      printf '%4d.%0*s%-.*ss \e[7m \e[m %s\n' "$((elapsed_line / 1000000))" "$((6 - ${#elapsed_line_micro_secs}))" 0 "$((4 - padding))" "$elapsed_line_micro_secs" "$last_line"

      last_line=$REPLY
    done
  }
}
